<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DVLZ Player Registry</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#070708;
      --panel:#0e0f12;
      --stroke:#1d1f26;
      --text:#ffffff;
      --muted:#b7b9c3;
      --red:#e50914;
      --red2:#ff2b2b;
      --ok:#18d07b;
      --warn:#ffcc66;

      --r:16px;
      --pad:14px;
      --shadow: 0 10px 24px rgba(0,0,0,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 420px at 15% 10%, rgba(229,9,20,.22), transparent 55%),
        radial-gradient(800px 420px at 85% 15%, rgba(255,43,43,.12), transparent 55%),
        linear-gradient(180deg, #050506 0%, #08090c 60%, #050506 100%);
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: clamp(14px, 2.5vw, 24px);
      display: grid;
      gap: 12px;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      padding: 6px 2px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 4px;
      line-height:1.1;
    }
    .brand h1{
      margin:0;
      font-size: clamp(18px, 3vw, 22px);
      letter-spacing:.3px;
    }
    .brand .sub{
      margin:0;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-family: var(--mono);
      font-size:12px;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(14,15,18,.7);
      backdrop-filter: blur(8px);
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--red);
      box-shadow: 0 0 0 3px rgba(229,9,20,.15);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 920px){
      .grid{ grid-template-columns: 1fr 1.2fr; }
    }

    .card{
      border:1px solid var(--stroke);
      background: rgba(14,15,18,.75);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card .hd{
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:
        linear-gradient(90deg, rgba(229,9,20,.22), transparent 55%);
    }
    .card .hd h2{
      margin:0;
      font-size: 13px;
      font-family: var(--mono);
      letter-spacing:.3px;
      text-transform: uppercase;
      color: #f3f4f7;
    }
    .card .bd{ padding: 14px; }

    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 520px){
      .row.two{ grid-template-columns: 1fr 1fr; }
      .row.three{ grid-template-columns: 1fr 1fr auto; align-items:end; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
      font-family: var(--mono);
    }
    input, select{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(7,7,8,.65);
      color: var(--text);
      outline:none;
      font-size: 14px;
    }
    input::placeholder{ color: rgba(255,255,255,.35); }
    input:focus, select:focus{
      border-color: rgba(229,9,20,.75);
      box-shadow: 0 0 0 3px rgba(229,9,20,.15);
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(229,9,20,.65);
      background: linear-gradient(180deg, rgba(229,9,20,.95), rgba(160,6,12,.95));
      color: white;
      padding: 11px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 700;
      letter-spacing:.2px;
      transition: transform .06s ease, filter .12s ease;
      user-select:none;
      width:100%;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ filter: brightness(1.05); }

    .btn.ghost{
      background: rgba(7,7,8,.35);
      border-color: var(--stroke);
      font-weight: 600;
      color: var(--muted);
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .hint code{
      font-family: var(--mono);
      color:#fff;
      background: rgba(229,9,20,.15);
      border:1px solid rgba(229,9,20,.35);
      padding: 1px 6px;
      border-radius: 999px;
    }

    .status{
      margin-top: 10px;
      font-family: var(--mono);
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(7,7,8,.35);
      color: var(--muted);
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .status.ok{ display:block; border-color: rgba(24,208,123,.35); color: #bff3da; }
    .status.err{ display:block; border-color: rgba(229,9,20,.45); color: #ffd2d6; }
    .status.warn{ display:block; border-color: rgba(255,204,102,.4); color: #ffe8b8; }

    .toolbar{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .toolbar .grow{ flex: 1 1 auto; min-width: 220px; }
    .toolbar input{ height: 42px; }
    .toolbar .btn{ width: auto; padding: 10px 12px; height: 42px; }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(7,7,8,.25);
    }
    thead th{
      text-align:left;
      font-size: 12px;
      font-family: var(--mono);
      color: var(--muted);
      padding: 10px 12px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(14,15,18,.6);
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(29,31,38,.7);
      font-size: 13px;
      vertical-align: top;
    }
    tbody tr:hover{ background: rgba(229,9,20,.06); }
    .mono{ font-family: var(--mono); }
    .muted{ color: var(--muted); }
    .tag{
      display:inline-flex;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(229,9,20,.35);
      background: rgba(229,9,20,.12);
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.2px;
    }
    .right{
      text-align:right;
      white-space:nowrap;
    }
    .smallbtn{
      font-family: var(--mono);
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: rgba(7,7,8,.35);
      color: var(--muted);
      cursor:pointer;
    }
    .smallbtn.danger{
      border-color: rgba(229,9,20,.45);
      color: #ffd2d6;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>DVLZ Player Registry</h1>
        <p class="sub">RED/BLACK • WHITE TEXT • COMPACT UI</p>
      </div>
      <div class="pill" title="Status server">
        <span class="dot" id="dot"></span>
        <span class="mono" id="serverState">checking…</span>
      </div>
    </header>

    <div class="grid">
      <!-- PLAYER FORM -->
      <section class="card">
        <div class="hd">
          <h2>Player Submit</h2>
          <span class="muted mono" id="apiBaseLabel"></span>
        </div>
        <div class="bd">
          <form id="playerForm" autocomplete="off">
            <div class="row two">
              <div>
                <label for="name">NAMA</label>
                <input id="name" name="name" placeholder="Contoh: Aqil" maxlength="40" required />
              </div>
              <div>
                <label for="role">ROLE</label>
                <select id="role" name="role" required>
                  <option value="">Pilih role…</option>
                  <option>Leader</option>
                  <option>Co-Leader</option>
                  <option>Strategist</option>
                  <option>Support</option>
                  <option>Entry</option>
                  <option>Sniper</option>
                  <option>Sub</option>
                  <option>Other</option>
                </select>
              </div>
            </div>

            <div class="row">
              <button class="btn" type="submit">HANTAR</button>
              <button class="btn ghost" type="button" id="clearMe">CLEAR</button>
            </div>

            <div class="hint">
              Data disimpan di server. Admin view guna <code>Admin Key</code> di panel kanan.
            </div>
            <div class="status" id="playerStatus"></div>
          </form>
        </div>
      </section>

      <!-- ADMIN PANEL -->
      <section class="card">
        <div class="hd">
          <h2>Admin Panel</h2>
          <span class="muted mono" id="countLabel">0</span>
        </div>
        <div class="bd">
          <div class="row three">
            <div class="grow">
              <label for="adminKey">ADMIN KEY</label>
              <input id="adminKey" placeholder="Masukkan admin key…" />
            </div>
            <div>
              <button class="btn" id="saveKey" type="button">SAVE</button>
            </div>
            <div>
              <button class="btn ghost" id="logoutKey" type="button">LOGOUT</button>
            </div>
          </div>

          <div class="toolbar" style="margin-top:12px;">
            <div class="grow">
              <label for="search">SEARCH</label>
              <input id="search" placeholder="Cari nama/role…" />
            </div>
            <div>
              <button class="btn" id="refresh" type="button">REFRESH</button>
            </div>
          </div>

          <div class="status" id="adminStatus"></div>

          <div style="margin-top:12px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th style="width:34%;">Name</th>
                  <th style="width:22%;">Role</th>
                  <th style="width:28%;">Created</th>
                  <th class="right" style="width:16%;">Action</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="4" class="muted mono">Sila login admin untuk view list.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="hint">
            Tip: letak <code>ADMIN_KEY</code> dalam server.js (backend) dan hanya awak tahu.
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
(() => {
  // === CONFIG ===
  // Kalau deploy di domain sama, biar kosong (auto).
  // Kalau backend lain domain: const API_BASE = "https://your-backend-domain.com";
  const API_BASE = "";
  const $ = (s) => document.querySelector(s);

  const apiBaseLabel = $("#apiBaseLabel");
  apiBaseLabel.textContent = API_BASE ? API_BASE.replace(/^https?:\/\//,'') : "local";

  const dot = $("#dot");
  const serverState = $("#serverState");

  const playerForm = $("#playerForm");
  const playerStatus = $("#playerStatus");
  const adminStatus = $("#adminStatus");
  const tbody = $("#tbody");
  const countLabel = $("#countLabel");

  const adminKeyInput = $("#adminKey");
  const searchInput = $("#search");

  const LS_KEY = "dvlz_admin_key_v1";

  function setStatus(el, type, msg){
    el.className = "status " + type;
    el.textContent = msg;
  }
  function clearStatus(el){
    el.className = "status";
    el.textContent = "";
  }

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch(e){ return iso; }
  }

  async function ping(){
    try{
      const r = await fetch(API_BASE + "/api/health", { cache:"no-store" });
      if(!r.ok) throw new Error("bad");
      dot.style.background = "var(--ok)";
      serverState.textContent = "server online";
    }catch(e){
      dot.style.background = "var(--red)";
      serverState.textContent = "server offline";
    }
  }

  function getKey(){
    return adminKeyInput.value.trim() || localStorage.getItem(LS_KEY) || "";
  }

  function loadSavedKey(){
    const k = localStorage.getItem(LS_KEY);
    if(k) adminKeyInput.value = k;
  }

  async function submitPlayer(name, role){
    clearStatus(playerStatus);
    const body = { name: name.trim(), role: role.trim() };
    const r = await fetch(API_BASE + "/api/register", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const data = await r.json().catch(() => ({}));
    if(!r.ok){
      throw new Error(data?.error || "Submit gagal.");
    }
    return data;
  }

  function renderRows(items){
    const q = searchInput.value.trim().toLowerCase();
    const filtered = !q ? items : items.filter(x =>
      (x.name||"").toLowerCase().includes(q) || (x.role||"").toLowerCase().includes(q)
    );

    countLabel.textContent = `${filtered.length}/${items.length}`;

    if(filtered.length === 0){
      tbody.innerHTML = `<tr><td colspan="4" class="muted mono">Tiada data match.</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(x => `
      <tr data-id="${x.id}">
        <td><span class="mono">${escapeHtml(x.name)}</span></td>
        <td><span class="tag">${escapeHtml(x.role)}</span></td>
        <td class="muted mono">${escapeHtml(fmtDate(x.created_at))}</td>
        <td class="right">
          <button class="smallbtn danger" data-del="${x.id}">DEL</button>
        </td>
      </tr>
    `).join("");
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    })[c]);
  }

  let cache = [];

  async function fetchList(){
    clearStatus(adminStatus);
    const key = getKey();
    if(!key){
      tbody.innerHTML = `<tr><td colspan="4" class="muted mono">Sila masukkan Admin Key.</td></tr>`;
      countLabel.textContent = "0";
      return;
    }

    const r = await fetch(API_BASE + "/api/list", {
      headers: { "x-admin-key": key },
      cache:"no-store"
    });
    const data = await r.json().catch(() => ({}));
    if(!r.ok){
      setStatus(adminStatus, "err", data?.error || "Tak boleh load list (Admin Key salah?).");
      tbody.innerHTML = `<tr><td colspan="4" class="muted mono">Access denied.</td></tr>`;
      countLabel.textContent = "0";
      return;
    }
    cache = data.items || [];
    renderRows(cache);
  }

  async function delItem(id){
    const key = getKey();
    const r = await fetch(API_BASE + "/api/delete/" + encodeURIComponent(id), {
      method:"DELETE",
      headers: { "x-admin-key": key },
    });
    const data = await r.json().catch(() => ({}));
    if(!r.ok){
      throw new Error(data?.error || "Delete gagal.");
    }
    return data;
  }

  // Events
  playerForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = $("#name").value;
    const role = $("#role").value;
    try{
      const res = await submitPlayer(name, role);
      setStatus(playerStatus, "ok", `OK ✅\nSaved: ${res.item?.name} • ${res.item?.role}`);
      $("#name").value = "";
      $("#role").value = "";
      $("#name").focus();
      // optional refresh list if admin key exists
      if(getKey()) fetchList();
    }catch(err){
      setStatus(playerStatus, "err", "ERROR ❌\n" + err.message);
    }
  });

  $("#clearMe").addEventListener("click", () => {
    $("#name").value = "";
    $("#role").value = "";
    clearStatus(playerStatus);
    $("#name").focus();
  });

  $("#saveKey").addEventListener("click", async () => {
    const k = adminKeyInput.value.trim();
    if(!k){
      setStatus(adminStatus, "warn", "Masukkan Admin Key dulu.");
      return;
    }
    localStorage.setItem(LS_KEY, k);
    setStatus(adminStatus, "ok", "Admin Key disimpan (local).");
    await fetchList();
  });

  $("#logoutKey").addEventListener("click", () => {
    localStorage.removeItem(LS_KEY);
    adminKeyInput.value = "";
    cache = [];
    countLabel.textContent = "0";
    tbody.innerHTML = `<tr><td colspan="4" class="muted mono">Logged out.</td></tr>`;
    setStatus(adminStatus, "ok", "Logged out.");
  });

  $("#refresh").addEventListener("click", fetchList);
  searchInput.addEventListener("input", () => renderRows(cache));

  tbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-del]");
    if(!btn) return;
    const id = btn.getAttribute("data-del");
    if(!confirm("Delete item ini?")) return;
    try{
      await delItem(id);
      setStatus(adminStatus, "ok", "Deleted ✅");
      await fetchList();
    }catch(err){
      setStatus(adminStatus, "err", "ERROR ❌\n" + err.message);
    }
  });

  // Init
  loadSavedKey();
  ping();
  setInterval(ping, 8000);
})();
</script>
</body>
</html>
